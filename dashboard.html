<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BackBeacon - Posture Dashboard</title>
    <style>
        :root {
            --bg-color: #121212; --card-color: #1E1E1E; --primary-text: #E0E0E0;
            --secondary-text: #B3B3B3; --accent-green: #1DB954; --accent-red: #E53935;
            --accent-blue: #2979FF; --border-color: #2c2c2c;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        body { background-color: var(--bg-color); color: var(--primary-text); margin: 0; padding: 24px; display: flex; justify-content: center; }
        .dashboard-container { display: grid; grid-template-columns: 300px 1fr; gap: 24px; width: 100%; max-width: 1400px; }
        .left-panel, .right-panel { display: flex; flex-direction: column; gap: 24px; }
        .card { background-color: var(--card-color); border-radius: 12px; padding: 20px; border: 1px solid var(--border-color); }
        h2 { margin: 0 0 16px 0; border-bottom: 1px solid var(--border-color); padding-bottom: 8px; }
        .weekly-summary .day { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid var(--border-color); }
        .weekly-summary .day:last-child { border-bottom: none; }
        .weekly-summary .day.today { background-color: rgba(41, 121, 255, 0.15); margin: 0 -20px; padding: 12px 20px; border-radius: 8px; }
        .weekly-summary .day-name { font-weight: 600; }
        .weekly-summary .day-score { font-weight: bold; padding: 4px 8px; border-radius: 6px; font-size: 0.9em; }
        .stat-item { display: flex; align-items: center; gap: 16px; }
        .stat-item .icon { font-size: 2em; }
        .stat-item .value { font-size: 1.8em; font-weight: bold; }
        .stat-item .label { font-size: 0.9em; color: var(--secondary-text); }
        .chart-container { position: relative; height: 100%; min-height: 400px; }
        .pie-chart-container { max-height: 350px; }
        .placeholder { text-align: center; padding: 40px; color: var(--secondary-text); }
        .refresh-button { background-color: var(--accent-blue); color: white; border: none; padding: 10px 15px; border-radius: 8px; font-weight: bold; cursor: pointer; text-align: center; margin-top: 10px; }
        .refresh-button:hover { background-color: #1e63d8; }
        @media (max-width: 900px) { .dashboard-container { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

    <div class="dashboard-container">
        <div class="left-panel">
            <div class="card weekly-summary">
                <h2>Weekly Progress</h2>
                <div id="weekly-view"><div class="placeholder">Click Refresh...</div></div>
            </div>
            <div class="card stats-today">
                <h2>Today's Analysis</h2>
                <div class="stat-item">
                    <div class="icon">‚è∞</div>
                    <div>
                        <div id="total-time" class="value">--:--</div>
                        <div class="label">Total Sitting Time</div>
                    </div>
                </div>
                <hr style="border-color: var(--border-color); margin: 20px 0;">
                <div class="stat-item">
                    <div class="icon">‚ö†Ô∏è</div>
                    <div>
                        <div id="slouch-alerts" class="value">0</div>
                        <div class="label">Slouch Alerts</div>
                    </div>
                </div>
                <hr style="border-color: var(--border-color); margin: 20px 0;">
                <div class="stat-item">
                    <div class="icon">üéØ</div>
                    <div>
                        <div id="posture-score" class="value">0%</div>
                        <div class="label">Overall Posture Score</div>
                    </div>
                </div>
                <button id="refreshBtn" class="refresh-button">üîÑ Refresh Data</button>
            </div>
        </div>

        <div class="right-panel">
            <div class="card main-chart-card">
                <h2>Today's Posture Pattern</h2>
                <p style="color: var(--secondary-text); margin-top: -10px; font-size: 0.9em;">
                    Shows your dominant posture in 5-minute intervals.
                </p>
                <div class="chart-container">
                    <canvas id="dailyPatternChart"></canvas>
                </div>
            </div>
            <div class="card pie-chart-card">
                <h2>Posture Quality Breakdown</h2>
                 <div class="pie-chart-container">
                    <canvas id="posturePieChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        // FIREBASE CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyCc8PCc1IYikEQXJ4_5avlOJM9JqIrH7Ac",
            authDomain: "backbeacon.firebaseapp.com",
            databaseURL: "https://backbeacon-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "backbeacon",
            storageBucket: "backbeacon.appspot.com",
            messagingSenderId: "287132718497",
            appId: "1:287132718497:web:99e72324a1ca257f1627e0"
        };
        
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const dbRef = database.ref('/backbeacon');

        let dailyChartInstance;
        let pieChartInstance;

        // --- Event Listener for Refresh Button ---
        document.getElementById('refreshBtn').addEventListener('click', fetchData);

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
             displayNoDataState();
             fetchData(); // Fetch data when page first loads
        });


        function fetchData() {
            console.log("Fetching data from Firebase...");
            document.getElementById('refreshBtn').innerText = 'üîÑ Loading...';
            dbRef.once('value').then((snapshot) => {
                const data = snapshot.val();
                if (data) {
                    processData(data);
                } else {
                    displayNoDataState();
                }
                document.getElementById('refreshBtn').innerText = 'üîÑ Refresh Data';
            }).catch(error => {
                console.error("Firebase read failed:", error);
                document.getElementById('refreshBtn').innerText = 'Error! Retry';
            });
        }

        function processData(firebaseData) {
            const entries = Object.values(firebaseData);
            const today = new Date().toLocaleDateString('en-CA');
            const dataByDay = {};

            for (const entry of entries) {
                try {
                    const entryDate = new Date(entry.timestamp).toLocaleDateString('en-CA');
                    if (!dataByDay[entryDate]) dataByDay[entryDate] = [];
                    dataByDay[entryDate].push(entry);
                } catch(e) { /* ignore invalid entries */ }
            }
            
            const todayData = dataByDay[today] || [];
            analyzeToday(todayData);
            analyzeWeek(dataByDay);
        }
        
        function analyzeToday(data) {
            if (data.length < 2) {
                displayNoDataState();
                return;
            }
            data.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

            let totalSitSeconds = 0, goodPostureSeconds = 0, slouchAlerts = 0;

            for (let i = 1; i < data.length; i++) {
                const prev = data[i - 1];
                const current = data[i];
                const durationSeconds = (new Date(current.timestamp) - new Date(prev.timestamp)) / 1000;

                if (prev.seat_status === "SEATED") {
                    totalSitSeconds += durationSeconds;
                    if (prev.posture === "Good") goodPostureSeconds += durationSeconds;
                }
                if (current.posture === "Bad" && prev.posture !== "Bad") {
                    slouchAlerts++;
                }
            }
            
            const postureScore = totalSitSeconds > 0 ? Math.round((goodPostureSeconds / totalSitSeconds) * 100) : 0;
            const badPostureSeconds = totalSitSeconds - goodPostureSeconds;
            
            const aggregatedChartData = aggregateDataForChart(data, 5); // 5-minute intervals

            updateTodayStatsUI(totalSitSeconds, slouchAlerts, postureScore);
            renderDailyPatternChart(aggregatedChartData);
            renderPosturePieChart(goodPostureSeconds, badPostureSeconds);
        }

        function aggregateDataForChart(data, intervalMinutes) {
            if (data.length < 2) return { labels: [], postureState: [] };
        
            const intervalMillis = intervalMinutes * 60 * 1000;
            const buckets = {};
        
            for (let i = 1; i < data.length; i++) {
                const prevEntry = data[i-1], currentEntry = data[i];
                const startTime = new Date(prevEntry.timestamp).getTime();
                const durationSeconds = (new Date(currentEntry.timestamp).getTime() - startTime) / 1000;
                const bucketKey = Math.floor(startTime / intervalMillis) * intervalMillis;

                if (!buckets[bucketKey]) buckets[bucketKey] = { goodSeconds: 0, badSeconds: 0 };

                if (prevEntry.seat_status === 'SEATED') {
                    if (prevEntry.posture === 'Good') buckets[bucketKey].goodSeconds += durationSeconds;
                    else if (prevEntry.posture === 'Bad') buckets[bucketKey].badSeconds += durationSeconds;
                }
            }

            const sortedKeys = Object.keys(buckets).sort();
            const labels = [], postureState = [];

            sortedKeys.forEach(key => {
                labels.push(new Date(parseInt(key)).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }));
                const bucket = buckets[key];
                if (bucket.badSeconds > bucket.goodSeconds) postureState.push(2);
                else if (bucket.goodSeconds > 0) postureState.push(1);
                else postureState.push(0);
            });
            return { labels, postureState };
        }

        function analyzeWeek(dataByDay) {
            const weeklyStats = [];
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateKey = date.toLocaleDateString('en-CA');
                const dayName = i === 0 ? "Today" : date.toLocaleDateString('en-US', { weekday: 'short' });
                
                let score = 0;
                const dayData = dataByDay[dateKey] || [];
                
                if (dayData.length > 1) {
                     dayData.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                     let totalSitSeconds = 0, goodPostureSeconds = 0;
                     for (let j = 1; j < dayData.length; j++) {
                         const duration = (new Date(dayData[j].timestamp) - new Date(dayData[j-1].timestamp)) / 1000;
                         if (dayData[j-1].seat_status === "SEATED") {
                             totalSitSeconds += duration;
                             if (dayData[j-1].posture === "Good") goodPostureSeconds += duration;
                         }
                     }
                     score = totalSitSeconds > 0 ? Math.round((goodPostureSeconds / totalSitSeconds) * 100) : 0;
                }
                weeklyStats.push({ dayName, score });
            }
            updateWeeklyUI(weeklyStats);
        }

        function formatTime(seconds) {
            const h = Math.floor(seconds / 3600).toString().padStart(2, '0');
            const m = Math.floor((seconds % 3600) / 60).toString().padStart(2, '0');
            return `${h}:${m}`;
        }
        
        function updateTodayStatsUI(time, alerts, score) {
            document.getElementById('total-time').innerText = `${formatTime(time)} hr`;
            document.getElementById('slouch-alerts').innerText = alerts;
            document.getElementById('posture-score').innerText = `${score}%`;
        }

        function updateWeeklyUI(stats) {
            const container = document.getElementById('weekly-view');
            container.innerHTML = '';
            stats.forEach(stat => {
                const scoreColor = stat.score > 80 ? 'var(--accent-green)' : stat.score > 50 ? 'var(--accent-blue)' : 'var(--accent-red)';
                container.innerHTML += `<div class="day ${stat.dayName === 'Today' ? 'today' : ''}"><span class="day-name">${stat.dayName}</span><span class="day-score" style="background-color:${scoreColor};color:white;">${stat.score}%</span></div>`;
            });
        }
        
        function displayNoDataState() {
             updateTodayStatsUI(0, 0, 0);
             document.querySelector('#weekly-view').innerHTML = '<div class="placeholder">No data for this week.</div>';
             if (dailyChartInstance) dailyChartInstance.destroy();
             if (pieChartInstance) pieChartInstance.destroy();
             document.querySelector('.main-chart-card .chart-container').innerHTML = '<div class="placeholder">Sit on the chair and click Refresh to track posture.</div>';
             document.querySelector('.pie-chart-card .pie-chart-container').innerHTML = '';
        }

        function renderDailyPatternChart(chartData) {
            const container = document.querySelector('.main-chart-card .chart-container');
            container.innerHTML = '<canvas id="dailyPatternChart"></canvas>'; // Reset canvas
            const ctx = document.getElementById('dailyPatternChart').getContext('2d');
            
            dailyChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: chartData.labels,
                    datasets: [{
                        label: 'Posture State', data: chartData.postureState, borderColor: 'rgba(41, 121, 255, 0.8)',
                        backgroundColor: 'rgba(41, 121, 255, 0.2)', fill: true, stepped: true,
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: {
                        y: { ticks: { color: 'var(--secondary-text)', callback: value => ['Away', 'Good', 'Slouching'][value] }, grid: { color: 'var(--border-color)' } },
                        x: { ticks: { color: 'var(--secondary-text)' }, grid: { display: false } }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }
        
        function renderPosturePieChart(goodSeconds, badSeconds) {
            const container = document.querySelector('.pie-chart-card .pie-chart-container');
            container.innerHTML = '<canvas id="posturePieChart"></canvas>'; // Reset canvas
            const ctx = document.getElementById('posturePieChart').getContext('2d');

            pieChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Good Posture Time', 'Slouching Time'],
                    datasets: [{
                        data: [goodSeconds, badSeconds],
                        backgroundColor: ['var(--accent-green)', 'var(--accent-red)'],
                        borderColor: 'var(--card-color)', borderWidth: 4
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom', labels: { color: 'var(--primary-text)' } } }
                }
            });
        }
    </script>
</body>
</html>
