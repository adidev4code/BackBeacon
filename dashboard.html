<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BackBeacon - Posture Dashboard</title>
    <style>
        /* --- Global Styles & Theme --- */
        :root {
            --bg-color: #121212;
            --card-color: #1E1E1E;
            --primary-text: #E0E0E0;
            --secondary-text: #B3B3B3;
            --accent-green: #1DB954;
            --accent-red: #E53935;
            --accent-blue: #2979FF;
            --border-color: #2c2c2c;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        }

        body {
            background-color: var(--bg-color);
            color: var(--primary-text);
            margin: 0;
            padding: 24px;
            display: flex;
            justify-content: center;
        }

        /* --- Main Layout --- */
        .dashboard-container {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 24px;
            width: 100%;
            max-width: 1400px;
        }

        .left-panel, .right-panel {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }
        
        .card {
            background-color: var(--card-color);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid var(--border-color);
        }

        h1, h2, h3 {
            margin: 0 0 16px 0;
            color: var(--primary-text);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 8px;
        }

        /* --- Left Panel: Weekly Summary --- */
        .weekly-summary .day {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
        }
        
        .weekly-summary .day:last-child {
            border-bottom: none;
        }

        .weekly-summary .day-name {
            font-weight: 600;
        }
        
        .weekly-summary .day-score {
            font-weight: bold;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.9em;
        }

        .weekly-summary .day.today {
            background-color: rgba(41, 121, 255, 0.15);
            margin: 0 -20px;
            padding: 12px 20px;
            border-radius: 8px;
        }

        /* --- Left Panel: Today's Stats --- */
        .stat-item {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .stat-item .icon {
            font-size: 2em;
        }
        
        .stat-item .value {
            font-size: 1.8em;
            font-weight: bold;
        }

        .stat-item .label {
            font-size: 0.9em;
            color: var(--secondary-text);
        }

        /* --- Right Panel: Charts --- */
        .chart-container {
            position: relative;
            height: 100%;
            min-height: 400px;
        }
        
        .pie-chart-container {
            max-height: 350px;
        }

        /* --- Loading and No Data State --- */
        .placeholder {
            text-align: center;
            padding: 40px;
            color: var(--secondary-text);
        }
        
        /* --- Responsive Design --- */
        @media (max-width: 900px) {
            .dashboard-container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>

    <div class="dashboard-container">
        <div class="left-panel">
            
            <div class="card weekly-summary">
                <h2>Weekly Progress</h2>
                <div id="weekly-view">
                    <div class="placeholder">Loading weekly data...</div>
                </div>
            </div>

            <div class="card stats-today">
                <h2>Today's Analysis</h2>
                <div class="stat-item">
                    <div class="icon">‚è∞</div>
                    <div>
                        <div id="total-time" class="value">--:--</div>
                        <div class="label">Total Sitting Time</div>
                    </div>
                </div>
                <hr style="border-color: var(--border-color); margin: 20px 0;">
                <div class="stat-item">
                    <div class="icon">‚ö†Ô∏è</div>
                    <div>
                        <div id="slouch-alerts" class="value">0</div>
                        <div class="label">Slouch Alerts</div>
                    </div>
                </div>
                <hr style="border-color: var(--border-color); margin: 20px 0;">
                <div class="stat-item">
                    <div class="icon">üéØ</div>
                    <div>
                        <div id="posture-score" class="value">0%</div>
                        <div class="label">Overall Posture Score</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="right-panel">

             <div class="card main-chart-card">
                <h2>Today's Posture Pattern</h2>
                <p style="color: var(--secondary-text); margin-top: -10px; font-size: 0.9em;">
                    Visualizes your posture throughout the day. Higher points indicate slouching.
                </p>
                <div class="chart-container">
                    <canvas id="dailyPatternChart"></canvas>
                </div>
            </div>
            
            <div class="card pie-chart-card">
                <h2>Posture Quality Breakdown</h2>
                 <div class="pie-chart-container">
                    <canvas id="posturePieChart"></canvas>
                </div>
            </div>

        </div>
    </div>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        // =============================================
        // ========= FIREBASE & CHART SETUP ============
        // =============================================

        // 1. YOUR FIREBASE CONFIGURATION -----------------
        const firebaseConfig = {
            apiKey: "AIzaSyCc8PCc1IYikEQXJ4_5avlOJM9JqIrH7Ac",
            authDomain: "backbeacon.firebaseapp.com",
            databaseURL: "https://backbeacon-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "backbeacon",
            storageBucket: "backbeacon.appspot.com",
            messagingSenderId: "287132718497",
            appId: "1:287132718497:web:99e72324a1ca257f1627e0"
        };
        // ---------------------------------------------
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const dbRef = database.ref('/backbeacon');

        // Chart instances
        let dailyChartInstance;
        let pieChartInstance;

        // =============================================
        // =========== DATA PROCESSING LOGIC ===========
        // =============================================

        dbRef.on('value', (snapshot) => {
            const data = snapshot.val();
            if (data) {
                processData(data);
            } else {
                console.log("No data found in Firebase.");
                displayNoDataState();
            }
        });

        function processData(firebaseData) {
            const entries = Object.values(firebaseData);
            const today = new Date().toLocaleDateString('en-CA'); // YYYY-MM-DD format
            
            const dataByDay = {};

            // Group data by day
            for (const entry of entries) {
                const entryDate = new Date(entry.timestamp).toLocaleDateString('en-CA');
                if (!dataByDay[entryDate]) {
                    dataByDay[entryDate] = [];
                }
                dataByDay[entryDate].push(entry);
            }

            // --- Analyze Today's Data ---
            const todayData = dataByDay[today] || [];
            analyzeToday(todayData);
            
            // --- Analyze Weekly Data ---
            analyzeWeek(dataByDay);
        }
        
        function analyzeToday(data) {
            if (data.length === 0) {
                displayNoDataState();
                return;
            }

            let totalSitSeconds = 0;
            let goodPostureSeconds = 0;
            let slouchAlerts = 0;

            // Sort data chronologically
            data.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
            
            let lastTimestamp = new Date(data[0].timestamp).getTime();

            const chartData = { labels: [], postureState: [] };
            let lastPosture = null;
            
            data.forEach((entry, index) => {
                const currentTimestamp = new Date(entry.timestamp).getTime();
                const durationSeconds = (currentTimestamp - lastTimestamp) / 1000;
                
                if (entry.seat_status === "SEATED") {
                    totalSitSeconds += durationSeconds;
                    if (entry.posture === "Good") {
                        goodPostureSeconds += durationSeconds;
                    } else if (entry.posture === "Bad" && lastPosture !== "Bad") {
                        slouchAlerts++;
                    }
                }
                
                // For chart
                const timeLabel = new Date(entry.timestamp).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                chartData.labels.push(timeLabel);
                chartData.postureState.push(entry.posture === "Good" ? 1 : (entry.posture === "Bad" ? 2 : 0));
                
                lastTimestamp = currentTimestamp;
                lastPosture = entry.posture;
            });
            
            // Calculate final metrics
            const postureScore = totalSitSeconds > 0 ? Math.round((goodPostureSeconds / totalSitSeconds) * 100) : 0;
            const badPostureSeconds = totalSitSeconds - goodPostureSeconds;

            // Update UI
            updateTodayStatsUI(totalSitSeconds, slouchAlerts, postureScore);
            renderDailyPatternChart(chartData);
            renderPosturePieChart(goodPostureSeconds, badPostureSeconds);
        }
        
        function analyzeWeek(dataByDay) {
            const weeklyStats = [];
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateKey = date.toLocaleDateString('en-CA');
                
                let dayName = date.toLocaleDateString('en-US', { weekday: 'short' });
                if (i === 0) dayName = "Today";

                const dayData = dataByDay[dateKey] || [];
                let score = 0;
                
                if (dayData.length > 0) {
                     dayData.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                     let totalSitSeconds = 0;
                     let goodPostureSeconds = 0;
                     let lastTimestamp = new Date(dayData[0].timestamp).getTime();

                     dayData.forEach(entry => {
                         const currentTimestamp = new Date(entry.timestamp).getTime();
                         const durationSeconds = (currentTimestamp - lastTimestamp) / 1000;
                         if(entry.seat_status === "SEATED") {
                             totalSitSeconds += durationSeconds;
                             if(entry.posture === "Good") goodPostureSeconds += durationSeconds;
                         }
                         lastTimestamp = currentTimestamp;
                     });
                     score = totalSitSeconds > 0 ? Math.round((goodPostureSeconds / totalSitSeconds) * 100) : 0;
                }
                weeklyStats.push({ dayName, score });
            }
            updateWeeklyUI(weeklyStats);
        }

        // =============================================
        // ========= UI UPDATE FUNCTIONS ===============
        // =============================================

        function formatTime(seconds) {
            if (isNaN(seconds) || seconds < 0) return "00:00";
            const h = Math.floor(seconds / 3600).toString().padStart(2, '0');
            const m = Math.floor((seconds % 3600) / 60).toString().padStart(2, '0');
            return `${h}:${m}`;
        }
        
        function updateTodayStatsUI(time, alerts, score) {
            document.getElementById('total-time').innerText = `${formatTime(time)} hr`;
            document.getElementById('slouch-alerts').innerText = alerts;
            document.getElementById('posture-score').innerText = `${score}%`;
        }

        function updateWeeklyUI(stats) {
            const container = document.getElementById('weekly-view');
            container.innerHTML = ''; // Clear previous content
            stats.forEach(stat => {
                const isToday = stat.dayName === 'Today';
                const scoreColor = stat.score > 80 ? 'var(--accent-green)' : stat.score > 50 ? 'var(--accent-blue)' : 'var(--accent-red)';
                
                const dayDiv = document.createElement('div');
                dayDiv.className = `day ${isToday ? 'today' : ''}`;
                dayDiv.innerHTML = `
                    <span class="day-name">${stat.dayName}</span>
                    <span class="day-score" style="background-color: ${scoreColor}; color: white;">${stat.score}%</span>
                `;
                container.appendChild(dayDiv);
            });
        }
        
        function displayNoDataState() {
             updateTodayStatsUI(0, 0, 0);
             document.querySelector('#weekly-view').innerHTML = '<div class="placeholder">No data for this week.</div>';
             if (dailyChartInstance) dailyChartInstance.destroy();
             if (pieChartInstance) pieChartInstance.destroy();
             document.querySelector('.main-chart-card .chart-container').innerHTML = '<div class="placeholder">Sit on the chair to start tracking posture.</div>';
             document.querySelector('.pie-chart-card .pie-chart-container').innerHTML = '';
        }

        // =============================================
        // =========== CHART RENDERING =================
        // =============================================
        
        function renderDailyPatternChart(chartData) {
            const ctx = document.getElementById('dailyPatternChart').getContext('2d');
            if (dailyChartInstance) {
                dailyChartInstance.destroy();
            }
            dailyChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: chartData.labels,
                    datasets: [{
                        label: 'Posture State',
                        data: chartData.postureState,
                        borderColor: 'rgba(41, 121, 255, 0.8)',
                        backgroundColor: 'rgba(41, 121, 255, 0.2)',
                        fill: true,
                        stepped: true,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            ticks: {
                                color: 'var(--secondary-text)',
                                callback: function(value) {
                                    if (value === 0) return 'Away';
                                    if (value === 1) return 'Good';
                                    if (value === 2) return 'Slouching';
                                }
                            },
                            grid: { color: 'var(--border-color)' }
                        },
                        x: {
                            ticks: { color: 'var(--secondary-text)' },
                            grid: { color: 'var(--border-color)' }
                        }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }
        
        function renderPosturePieChart(goodSeconds, badSeconds) {
            const ctx = document.getElementById('posturePieChart').getContext('2d');
            if(pieChartInstance) {
                pieChartInstance.destroy();
            }
            pieChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Good Posture Time', 'Slouching Time'],
                    datasets: [{
                        data: [goodSeconds, badSeconds],
                        backgroundColor: ['var(--accent-green)', 'var(--accent-red)'],
                        borderColor: 'var(--card-color)',
                        borderWidth: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: 'var(--primary-text)' }
                        }
                    }
                }
            });
        }

    </script>
</body>
</html>
